<ion-content>
  <div class="history-mobile-container">
    <div class="history-list-card">
      <div class="history-list-header">
        <span class="history-list-title">Historial de Recorridos</span>
      </div>
      <div *ngIf="userRunRoutes && userRunRoutes.length > 0; else noRoutes">
        <div *ngFor="let routeRun of userRunRoutes" class="route-item" (click)="openRouteDetails(routeRun)">
          <div class="route-info">
            <div class="route-nombre">{{ routeRun.route?.name }}</div>
            <div class="route-details">
              <span>Inicio: {{ routeRun.start_time | date: 'short' }}</span>
              <span *ngIf="routeRun.end_time">Fin: {{ routeRun.end_time | date: 'short' }}</span>
              <span *ngIf="routeRun.incidents && routeRun.incidents.length > 0">
                Incidentes: {{ routeRun.incidents.length }}
              </span>
            </div>
          </div>
          <ion-icon name="chevron-forward-outline" class="view-icon"></ion-icon>
        </div>
      </div>
      <ng-template #noRoutes>
        <div class="no-routes-message">
          <p>No hay recorridos registrados</p>
        </div>
      </ng-template>
    </div>
  </div>
</ion-content>

<!-- Modal de detalles -->
<ion-modal [isOpen]="isModalOpen" (didDismiss)="onModalDismiss()" class="route-details-modal">
  <ng-template ionModalContent>
    <ion-header>
      <ion-toolbar color="dark">
        <ion-buttons slot="end">
          <ion-button (click)="closeRouteDetails()">Cerrar</ion-button>
        </ion-buttons>
        <ion-title>Detalles del Recorrido</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content *ngIf="selectedRoute" class="modal-content">
      <!-- Información General -->
      <div class="details-section">
        <div class="section-title">Información General</div>
        <ion-item lines="none">
          <ion-label>
            <div class="label-strong">Ruta:</div>
            <div class="label-value">{{ selectedRoute.route?.name }}</div>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-label>
            <div class="label-strong">Usuario:</div>
            <div class="label-value">{{ selectedRoute.user?.name }}</div>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-label>
            <div class="label-strong">Inicio:</div>
            <div class="label-value">{{ selectedRoute.start_time | date: 'medium' }}</div>
          </ion-label>
        </ion-item>
        <ion-item lines="none" *ngIf="selectedRoute.end_time">
          <ion-label>
            <div class="label-strong">Fin:</div>
            <div class="label-value">{{ selectedRoute.end_time | date: 'medium' }}</div>
          </ion-label>
        </ion-item>
      </div>

      <!-- Información de Origen y Destino -->
      <div class="details-section">
        <div class="section-title">Recorrido</div>
        <ion-item lines="none">
          <ion-label>
            <div class="label-strong">Origen:</div>
            <div class="label-value">{{ selectedRoute.route?.startPlace?.name }}</div>
          </ion-label>
        </ion-item>
        <ion-item lines="none">
          <ion-label>
            <div class="label-strong">Destino:</div>
            <div class="label-value">{{ selectedRoute.route?.endPlace?.name }}</div>
          </ion-label>
        </ion-item>
      </div>

      <!-- Incidentes -->
      <div class="details-section">
        <div class="section-title">
          Incidentes
          <span class="incident-badge" *ngIf="selectedRoute.incidents && selectedRoute.incidents.length > 0">
            {{ selectedRoute.incidents.length }}
          </span>
        </div>
        <div *ngIf="selectedRoute.incidents && selectedRoute.incidents.length > 0; else noIncidents">
          <div *ngFor="let incident of selectedRoute.incidents" class="incident-card" (click)="openIncidentDetails(incident)">
            <div class="incident-header">
              <span class="incident-date">{{ incident.date | date: 'short' }}</span>
              <ion-icon name="chevron-forward-outline" class="incident-arrow"></ion-icon>
            </div>
            <div class="incident-description" *ngIf="incident.description && incident.description !== 'null'">
              <strong>Descripción:</strong> {{ incident.description }}
            </div>
            <div class="incident-description" *ngIf="incident.place?.name">
              <strong>Ubicación:</strong> {{ incident.place?.name }}
            </div>
            <div class="incident-evidences" *ngIf="incident.evidences && incident.evidences.length > 0">
              <ion-icon name="document-attach-outline"></ion-icon>
              <span>{{ incident.evidences.length }} evidencia(s)</span>
            </div>
          </div>
        </div>
        <ng-template #noIncidents>
          <div class="no-items-message">Sin incidentes reportados</div>
        </ng-template>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>

<!-- Modal de detalles de incidente -->
<ion-modal [isOpen]="isIncidentModalOpen" (didDismiss)="onIncidentModalDismiss()" class="incident-detail-modal">
  <ng-template ionModalContent>
    <ion-header>
      <ion-toolbar color="danger">
        <ion-buttons slot="start">
          <ion-button (click)="closeIncidentDetails()">
            <ion-icon name="arrow-back-outline"></ion-icon>
          </ion-button>
        </ion-buttons>
        <ion-title>Detalle del Incidente</ion-title>
      </ion-toolbar>
    </ion-header>
    <ion-content *ngIf="selectedIncident" class="incident-modal-content">
      <!-- Información del Incidente -->
      <div class="incident-detail-section">
        <div class="section-title">Información</div>
        <ion-item lines="none">
          <ion-label>
            <div class="label-strong">Fecha:</div>
            <div class="label-value">{{ selectedIncident.date | date: 'medium' }}</div>
          </ion-label>
        </ion-item>
        <ion-item lines="none" *ngIf="selectedIncident.description && selectedIncident.description !== 'null'">
          <ion-label>
            <div class="label-strong">Descripción:</div>
            <div class="label-value">{{ selectedIncident.description }}</div>
          </ion-label>
        </ion-item>
        <ion-item lines="none" *ngIf="selectedIncident.place?.name">
          <ion-label>
            <div class="label-strong">Ubicación:</div>
            <div class="label-value">{{ selectedIncident.place.name }}</div>
          </ion-label>
        </ion-item>
      </div>

      <!-- Evidencias -->
      <div class="incident-detail-section" *ngIf="selectedIncident.evidences && selectedIncident.evidences.length > 0">
        <div class="section-title">
          Evidencias ({{ selectedIncident.evidences.length }})
        </div>
        
        <div *ngIf="loadingEvidences" class="loading-evidences">
          <ion-spinner name="crescent"></ion-spinner>
          <p>Cargando evidencias...</p>
        </div>

        <div class="evidences-grid">
          <div *ngFor="let evidence of selectedIncident.evidences" class="evidence-item">
            <div class="evidence-header">
              <ion-icon 
                [name]="isImageEvidence(evidence) ? 'image-outline' : isAudioEvidence(evidence) ? 'volume-high-outline' : isVideoEvidence(evidence) ? 'videocam-outline' : 'document-outline'"
                class="evidence-icon"
              ></ion-icon>
              <span class="evidence-name">{{ evidence.file_name }}</span>
            </div>
            
            <!-- Preview de Imagen -->
            <div *ngIf="isImageEvidence(evidence) && getEvidenceUrl(evidence.id)" class="evidence-preview">
              <img [src]="getEvidenceUrl(evidence.id)" [alt]="evidence.file_name" />
            </div>

            <!-- Audio Player -->
            <div *ngIf="isAudioEvidence(evidence) && getEvidenceUrl(evidence.id)" class="evidence-audio">
              <audio controls [src]="getEvidenceUrl(evidence.id)">
                Tu navegador no soporta audio HTML5.
              </audio>
            </div>

            <!-- Video Player -->
            <div *ngIf="isVideoEvidence(evidence) && getEvidenceUrl(evidence.id)" class="evidence-video">
              <video controls [src]="getEvidenceUrl(evidence.id)">
                Tu navegador no soporta video HTML5.
              </video>
            </div>

            <div class="evidence-info">
              <span class="evidence-size">{{ (evidence.file_size / 1024).toFixed(2) }} KB</span>
              <span class="evidence-type">{{ evidence.file_type }}</span>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="!selectedIncident.evidences || selectedIncident.evidences.length === 0" class="no-evidences-message">
        <ion-icon name="document-outline" class="no-evidence-icon"></ion-icon>
        <p>No hay evidencias registradas para este incidente</p>
      </div>
    </ion-content>
  </ng-template>
</ion-modal>